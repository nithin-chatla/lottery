<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surprise Lottery – Agent Managed</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }
        .main-container {
            width: 100%;
            max-width: 1200px;
            padding: 1rem;
        }
        .card {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .btn-primary {
            background-color: #2F80ED; /* Blue */
            color: white;
            transition: background-color 0.15s;
        }
        .btn-primary:hover {
            background-color: #296EB4;
        }
        .btn-gold {
            background-color: #FFD700; /* Gold */
            color: #333;
            font-weight: 600;
            transition: background-color 0.15s;
        }
        .btn-gold:hover {
            background-color: #FFC107;
        }
        .admin-section {
            border: 1px dashed #f00;
            padding: 1rem;
            margin-top: 1rem;
            background-color: #fef2f2;
            border-radius: 0.5rem;
        }
        .agent-section {
            border: 1px dashed #00f;
            padding: 1rem;
            margin-top: 1rem;
            background-color: #eff6ff;
            border-radius: 0.5rem;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .verified { color: #10B981; }
        .pending { color: #F59E0B; }
        .canceled { color: #EF4444; }
    </style>
</head>
<body>

    <div class="main-container">
        
        <!-- Global Header/Auth Status -->
        <header class="flex justify-between items-center p-4 bg-white shadow-md rounded-xl mb-4">
            <h1 id="app-title" class="text-2xl font-black text-blue-700 cursor-pointer" onclick="renderView('home')">
                Surprise Lottery
            </h1>
            <div id="auth-status-header" class="flex items-center space-x-2">
                <span id="user-role-display" class="text-sm font-semibold text-gray-600">Guest</span>
                <button id="auth-button" class="px-3 py-1 text-xs font-semibold rounded-lg text-white bg-blue-500 hover:bg-blue-600">
                    Sign In
                </button>
            </div>
        </header>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay hidden">
            <div class="text-xl font-semibold text-blue-600">Loading...</div>
        </div>

        <!-- Main Content Area (Views are rendered here) -->
        <main class="mt-4">
            <div id="status-message-global" class="mb-4 p-3 rounded-lg text-center font-medium bg-red-100 text-red-700 hidden"></div>

            <!-- 1. HOME VIEW (Default/Guest) -->
            <div id="home-view" class="card space-y-8 hidden">
                <div class="text-center">
                    <h2 class="text-5xl font-extrabold text-blue-800 mb-4">
                        Join the Exciting Surprise Lottery – Only ₹99 Entry!
                    </h2>
                    <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                        Register via our authorized agents, get your unique serial number instantly, and win amazing prizes! Prize revealed after ticket sales end.
                    </p>
                    <div id="countdown-timer" class="text-3xl font-bold mt-6 text-gold-600">Ticket sales ending in: --:--:--</div>
                </div>

                <!-- LOGIN CONTAINER (MODIFIED FOR ADMIN/AGENT SEPARATION) -->
                <div id="login-form-container" class="hidden max-w-lg mx-auto p-4 border border-blue-300 bg-blue-50 rounded-xl grid grid-cols-1 md:grid-cols-2 gap-4">
                    
                    <!-- ADMIN LOGIN (Google) -->
                    <div class="p-4 bg-white rounded-lg shadow">
                        <p class="text-center text-lg font-bold text-red-700 mb-4">Admin Login</p>
                        <button id="google-sign-in-btn" type="button" class="w-full py-2 bg-red-600 text-white rounded-lg font-bold flex items-center justify-center shadow-md hover:bg-red-700 transition duration-150">
                             <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill="#FFC107" d="M30 44c4.4 0 8.7-1.4 12.1-4.3l-5-4.1c-2.3 2-5 3.1-7.1 3.1-6.1 0-11.2-4.1-13-9.5H0v5.3C3.5 39.5 16 44 30 44z"/><path fill="#FF3D00" d="M16 24c0-1.6.4-3.2.9-4.7V14.5H0V19c0 7.2 4.6 13.5 11.2 15.8l4.8-4.1c-.2-1.2-.5-2.5-.5-4.7z"/><path fill="#4CAF50" d="M30 14.5c3.2 0 6.1 1.1 8.4 3.1l4.4-4.2C39 10.1 34.6 8 30 8c-6 0-11.7 3-15.5 8.3l4.8 4.1c1.4-3.9 5.3-6.9 10.7-6.9z"/><path fill="#1976D2" d="M48 24c0-.9-.1-1.6-.2-2.4H30v4.7h10.4c-.6 3-2.3 5.4-4.8 7.3l4.1 3.5c3.5-3.3 5.5-8 5.5-13.1z"/></svg>
                            Sign in as Admin (Google)
                        </button>
                    </div>

                    <!-- AGENT LOGIN (Email/Password) -->
                    <div class="p-4 bg-white rounded-lg shadow">
                        <p class="text-center text-lg font-bold text-blue-700 mb-4">Agent Login</p>
                        <input id="agent-login-email" type="email" placeholder="Email" class="w-full p-2 border rounded-lg mb-2">
                        <input id="agent-login-password" type="password" placeholder="Password" class="w-full p-2 border rounded-lg mb-4">
                        <button id="agent-sign-in-btn" type="button" class="btn-primary w-full py-2 rounded-lg font-bold">
                            Agent Sign In
                        </button>
                    </div>
                    
                    <div class="col-span-1 md:col-span-2">
                        <p id="login-error" class="text-red-500 text-sm mt-3 text-center hidden"></p>
                    </div>
                </div>
                <!-- END LOGIN CONTAINER -->

                <div class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-4">
                    <button id="home-agent-login-btn" class="btn-primary py-3 px-8 rounded-xl text-lg shadow-lg">
                        Agent/Admin Login
                    </button>
                    <button onclick="renderView('verification')" class="btn-gold py-3 px-8 rounded-xl text-lg shadow-lg">
                        Participant Verification
                    </button>
                </div>
            </div>

            <!-- 2. AGENT PANEL VIEW -->
            <div id="agent-view" class="card hidden">
                <h2 class="text-3xl font-bold text-blue-700 mb-6">Agent Panel Dashboard</h2>
                
                <!-- Agent Stats -->
                <div id="agent-stats" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="p-4 bg-blue-100 rounded-lg text-center">
                        <p class="text-sm text-blue-600">Total Participants</p>
                        <p id="agent-stat-total" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="p-4 bg-yellow-100 rounded-lg text-center">
                        <p class="text-sm text-yellow-600">Pending Payments</p>
                        <p id="agent-stat-pending" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="p-4 bg-green-100 rounded-lg text-center">
                        <p class="text-sm text-green-600">Verified Payments</p>
                        <p id="agent-stat-verified" class="text-2xl font-bold">0</p>
                    </div>
                </div>

                <!-- Registration & Serial Generation -->
                <div class="agent-section border-blue-400">
                    <h3 class="text-xl font-semibold text-blue-700 mb-4">Generate Serial Number</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <select id="agent-lottery-select" class="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-3"></select>
                        <input id="agent-participant-name" type="text" placeholder="Participant Name (Required)" class="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <input id="agent-participant-phone" type="tel" placeholder="Phone (Optional)" class="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <input id="agent-payment-proof-ref" type="text" placeholder="Payment Proof Ref (e.g., UPI ID/Cash)" class="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button id="agent-generate-btn" class="btn-primary w-full mt-4 py-3 rounded-lg text-lg disabled:opacity-50" disabled>
                        Generate & Register Participant
                    </button>
                    <p id="agent-status" class="text-sm mt-3 text-center hidden"></p>
                </div>

                <!-- Agent Participant List -->
                <div class="mt-8">
                    <h3 class="text-xl font-semibold text-blue-700 mb-4">My Registered Participants (Offline Payments)</h3>
                    <p class="text-sm text-gray-500 mb-4">These participants have been registered by you. Their payments must be verified by the Admin after you have collected the cash/proof.</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Serial</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name & Phone</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lottery</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proof Ref</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="agent-participants-table" class="bg-white divide-y divide-gray-200">
                                <!-- Agent participant data rendered here -->
                                <tr><td colspan="5" class="text-center py-4 text-gray-500">No participants registered yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 3. ADMIN PANEL VIEW -->
            <div id="admin-view" class="card hidden">
                <h2 class="text-3xl font-bold text-red-700 mb-6">Admin Panel (Lottery & User Management)</h2>

                <!-- Lottery Management -->
                <div class="admin-section border-red-400 mb-8">
                    <h3 class="text-xl font-semibold text-red-700 mb-4">Lottery Management (Add New)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input id="lottery-title" type="text" placeholder="Title (e.g., Oct 2025)" class="p-3 border rounded-lg">
                        <input id="lottery-fee" type="number" placeholder="Entry Fee (₹)" value="99" class="p-3 border rounded-lg">
                        <input id="lottery-max-tickets" type="number" placeholder="Max Tickets" value="300" class="p-3 border rounded-lg">
                        <input id="lottery-end-date" type="datetime-local" class="p-3 border rounded-lg">
                        <input id="lottery-draw-date" type="datetime-local" class="p-3 border rounded-lg">
                        <select id="lottery-status" class="p-3 border rounded-lg">
                            <option value="Draft">Draft</option>
                            <option value="Active">Active</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    <textarea id="lottery-description" placeholder="Description/Rules" class="w-full p-3 border rounded-lg mt-4"></textarea>
                    <button id="admin-add-lottery-btn" class="btn-danger w-full mt-4 py-3 rounded-lg text-lg">Add New Lottery</button>
                    <p id="admin-lottery-status" class="text-sm mt-3 text-center hidden"></p>
                </div>

                <!-- Admin Participant List & Verification -->
                <div>
                    <h3 class="text-xl font-semibold text-red-700 mb-4">All Participants & Payment Verification</h3>
                    <div class="flex space-x-4 mb-4">
                        <select id="admin-lottery-filter" class="p-3 border rounded-lg flex-grow"></select>
                        <select id="admin-agent-filter" class="p-3 border rounded-lg flex-grow"></select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Serial</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Agent ID</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proof Ref</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody id="admin-participants-table" class="bg-white divide-y divide-gray-200">
                                <!-- Admin participant data rendered here -->
                                <tr><td colspan="6" class="text-center py-4 text-gray-500">Sign in as Admin to view data.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 4. PARTICIPANT VERIFICATION VIEW -->
            <div id="verification-view" class="card hidden max-w-lg mx-auto">
                <h2 class="text-3xl font-bold text-green-700 mb-6 text-center">Participant Verification</h2>
                <input id="verification-serial" type="text" placeholder="Enter Serial Number (e.g., LOTOCT-001)" class="w-full p-3 border rounded-lg focus:ring-green-500 focus:border-green-500 mb-4">
                <button id="verification-submit-btn" class="btn-gold w-full py-3 rounded-lg text-lg">Check Status</button>
                
                <div id="verification-result" class="mt-6 p-4 rounded-lg border hidden">
                    <p class="text-lg font-semibold text-gray-800">Registration Status:</p>
                    <p id="verification-status-output" class="text-2xl font-bold mt-2 verified">Verified</p>
                    <p id="verification-lottery-output" class="text-sm text-gray-500 mt-2">Lottery: </p>
                    <p id="verification-name-output" class="text-sm text-gray-500">Name: </p>
                </div>
                <p id="verification-status-message" class="text-sm mt-3 text-center hidden"></p>
            </div>
            
            <!-- 5. PRIZE ANNOUNCEMENT VIEW (Placeholder) -->
            <div id="prize-view" class="card hidden">
                <h2 class="text-3xl font-bold text-purple-700 mb-6 text-center">Prize Announcement!</h2>
                <p class="text-center text-gray-600">
                    This page would display the total participants, the winning serial numbers, and images of the prizes after the draw date.
                </p>
                <!-- Static placeholder content -->
                <div class="mt-6 p-6 bg-purple-100 rounded-lg text-center">
                    <p class="text-xl font-bold text-purple-800">Winning Lottery: MEGA OCT 2025</p>
                    <p class="text-4xl font-extrabold text-yellow-500 mt-4">Winner: LOTOCT-042</p>
                    <p class="mt-4"></p>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, runTransaction, setDoc, getDoc, setLogLevel, collection, addDoc, updateDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { nanoid } from 'https://cdn.jsdelivr.net/npm/nanoid/nanoid.js';

        // --- CONFIGURATION AND GLOBAL STATE ---

        // The specific Firebase config provided by the user.
        const firebaseConfig = {
            apiKey: "AIzaSyDbmO6koXLqaFPJJo0YyTD9khEB-V-H2xk",
            authDomain: "luckyone-def58.firebaseapp.com",
            projectId: "luckyone-def55", // Using a unique ID for collections
            storageBucket: "luckyone-def58.firebasestorage.app",
            messagingSenderId: "625257358119",
            appId: "1:625257358119:web:5d8f4a2c5715bfc1237f02",
            measurementId: "G-HWSQNKTJ9D"
        };
        
        // Role Configuration
        const ADMIN_EMAIL = 'admin@lottery.com'; 
        const AGENT_EMAILS = ['agent1@lottery.com', 'agent2@lottery.com']; // Hardcoded Agents for Demo

        // Firebase Path Setup
        const APP_ID = 'surprise-lottery-v1'; 
        const COLLECTIONS = {
            LOTTERIES: `/artifacts/${APP_ID}/public/data/lotteries`,
            COUNTERS: `/artifacts/${APP_ID}/public/data/lottery_counters`, // Separate collection for safe transaction
            PARTICIPANTS: `/artifacts/${APP_ID}/public/data/participants`,
            AGENTS: `/artifacts/${APP_ID}/public/data/agents`
        };

        let db;
        let auth;
        let googleProvider;
        let userRole = 'guest'; // guest | agent | admin
        let currentUserId = null;
        let currentUserEmail = null;
        let currentAgentId = null;

        // Global State for Listeners
        let lotteryUnsub = null;
        let agentUnsub = null;
        let adminUnsub = null;
        let participantUnsub = null;
        let agentStatsUnsub = null;
        
        // --- DOM ELEMENTS (Declared as let, assigned in setupListeners) ---
        
        // Views
        let views = {};
        // Status/Auth
        let loadingOverlay, globalStatusMsg, authButton, userRoleDisplay, loginFormContainer, googleSignInBtn, loginError;
        let agentLoginEmail, agentLoginPassword, agentSignInBtn; // NEW AGENT LOGIN ELEMENTS

        // Agent Elements
        let agentLotterySelect, agentParticipantName, agentParticipantPhone, agentPaymentProofRef, agentGenerateBtn, agentStatus, agentParticipantsTable;
        // Admin Elements
        let adminLotteryFilter, adminAgentFilter, adminParticipantsTable;
        // Verification Elements
        let verificationSerial, verificationSubmitBtn, verificationResult, verificationStatusOutput, verificationLotteryOutput, verificationNameOutput, verificationStatusMessage;

        
        /**
         * Fetches all DOM elements and assigns event listeners.
         * This MUST be called only after the DOM is fully loaded.
         */
        function setupListenersAndElements() {
            // 1. Fetch Elements
            views = {
                home: document.getElementById('home-view'),
                agent: document.getElementById('agent-view'),
                admin: document.getElementById('admin-view'),
                verification: document.getElementById('verification-view'),
                prize: document.getElementById('prize-view')
            };
            loadingOverlay = document.getElementById('loading-overlay');
            globalStatusMsg = document.getElementById('status-message-global');
            authButton = document.getElementById('auth-button');
            userRoleDisplay = document.getElementById('user-role-display');
            
            // Auth Elements
            loginFormContainer = document.getElementById('login-form-container'); 
            googleSignInBtn = document.getElementById('google-sign-in-btn');
            loginError = document.getElementById('login-error'); 
            agentLoginEmail = document.getElementById('agent-login-email'); // NEW
            agentLoginPassword = document.getElementById('agent-login-password'); // NEW
            agentSignInBtn = document.getElementById('agent-sign-in-btn'); // NEW

            // Agent Elements
            agentLotterySelect = document.getElementById('agent-lottery-select');
            agentParticipantName = document.getElementById('agent-participant-name');
            agentParticipantPhone = document.getElementById('agent-participant-phone');
            agentPaymentProofRef = document.getElementById('agent-payment-proof-ref');
            agentGenerateBtn = document.getElementById('agent-generate-btn');
            agentStatus = document.getElementById('agent-status');
            agentParticipantsTable = document.getElementById('agent-participants-table');
            
            // Admin Elements
            adminLotteryFilter = document.getElementById('admin-lottery-filter');
            adminAgentFilter = document.getElementById('admin-agent-filter');
            adminParticipantsTable = document.getElementById('admin-participants-table');
            
            // Verification Elements
            verificationSerial = document.getElementById('verification-serial');
            verificationSubmitBtn = document.getElementById('verification-submit-btn');
            verificationResult = document.getElementById('verification-result');
            verificationStatusOutput = document.getElementById('verification-status-output');
            verificationLotteryOutput = document.getElementById('verification-lottery-output');
            verificationNameOutput = document.getElementById('verification-name-output');
            verificationStatusMessage = document.getElementById('verification-status-message');


            // 2. Attach Listeners
            if (googleSignInBtn) googleSignInBtn.addEventListener('click', handleGoogleSignIn);
            if (agentSignInBtn) agentSignInBtn.addEventListener('click', handleAgentLogin); // NEW AGENT LOGIN LISTENER
            
            document.getElementById('home-agent-login-btn').addEventListener('click', () => {
                 if (loginFormContainer) loginFormContainer.classList.remove('hidden');
            });
            
            // Admin
            if (document.getElementById('admin-add-lottery-btn')) {
                document.getElementById('admin-add-lottery-btn').addEventListener('click', handleAddLottery);
            }
            
            // Agent
            if (agentGenerateBtn) agentGenerateBtn.addEventListener('click', handleGenerateSerial);
            
            // Verification
            if (verificationSubmitBtn) verificationSubmitBtn.addEventListener('click', handleVerification);
        }


        // --- UTILITY FUNCTIONS ---

        /**
         * Converts Firestore Timestamp to readable string.
         */
        const toLocaleString = (timestamp) => {
            return timestamp && timestamp.toDate ? timestamp.toDate().toLocaleString() : 'N/A';
        };

        /**
         * Clears all existing Firestore listeners.
         */
        function clearAllListeners() {
            [lotteryUnsub, agentUnsub, adminUnsub, participantUnsub, agentStatsUnsub].forEach(unsub => {
                if (typeof unsub === 'function') {
                    unsub();
                }
            });
            lotteryUnsub = agentUnsub = adminUnsub = participantUnsub = agentStatsUnsub = null;
        }

        /**
         * Renders the specified view and handles header buttons.
         * @param {string} viewName - Name of the view to render.
         */
        function renderView(viewName) {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            
            const targetView = views[viewName] || views.home;
            targetView.classList.remove('hidden');

            // Reset status messages
            if(agentStatus) agentStatus.classList.add('hidden');
            if(globalStatusMsg) globalStatusMsg.classList.add('hidden');
            
            // Trigger view-specific data loads
            if (viewName === 'agent' && userRole === 'agent') {
                loadAgentData();
            } else if (viewName === 'admin' && userRole === 'admin') {
                loadAdminData();
            }
        }
        
        // --- FIREBASE INITIALIZATION & AUTH ---

        /**
         * Initializes Firebase and sets up the Auth state listener.
         */
        async function initFirebase() {
            try {
                setLogLevel('Debug');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                googleProvider = new GoogleAuthProvider();

                if(loadingOverlay) loadingOverlay.classList.remove('hidden');
                onAuthStateChanged(auth, handleAuthStateChange);

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                if(globalStatusMsg) {
                    globalStatusMsg.textContent = `Fatal Error: ${error.message}. Please check console.`;
                    globalStatusMsg.classList.remove('hidden');
                }
                if(loadingOverlay) loadingOverlay.classList.add('hidden');
            }
        }

        /**
         * Handles changes in the user's authentication state (login/logout).
         * @param {Object} user - The currently authenticated user object or null.
         */
        function handleAuthStateChange(user) {
            clearAllListeners(); // Clear all old listeners on auth state change
            currentUserId = user ? user.uid : null;
            currentUserEmail = user ? user.email : null;
            userRole = 'guest';
            currentAgentId = null;

            if (user) {
                // Determine Role based on Email
                if (user.email === ADMIN_EMAIL) {
                    userRole = 'admin';
                    renderView('admin');
                } else if (AGENT_EMAILS.includes(user.email)) {
                    userRole = 'agent';
                    // Agent ID is generated from UID for unique tracking
                    currentAgentId = 'AGENT-' + user.uid.substring(0, 8).toUpperCase(); // Using 8 chars for better distinction
                    renderView('agent');
                } else {
                    userRole = 'participant'; // Signed in user but not admin/agent
                    renderView('home');
                }

                userRoleDisplay.textContent = userRole.toUpperCase();
                authButton.textContent = 'Logout';
                authButton.onclick = handleLogout; 

            } else {
                userRole = 'guest';
                userRoleDisplay.textContent = 'GUEST';
                authButton.textContent = 'Sign In';
                authButton.onclick = () => renderView('home');
                renderView('home');
            }

            // Update UI/Header based on role
            authButton.classList.remove('hidden');
            if (loadingOverlay) loadingOverlay.classList.add('hidden');
            if (loginFormContainer) loginFormContainer.classList.add('hidden');
            
            // Set up listener for the main Lottery Selector when authenticated
            if (userRole !== 'guest') {
                setupLotterySelectorListener();
            }
        }

        /**
         * Handles the Google Sign-In process (for Admin).
         */
        async function handleGoogleSignIn() {
            if(loginError) loginError.classList.add('hidden');
            try {
                if(loadingOverlay) loadingOverlay.classList.remove('hidden');
                await signInWithPopup(auth, googleProvider);
                // AuthStateChanged will handle role assignment and view change
            } catch (error) {
                console.error("Google Sign-In failed:", error.code, error.message);
                if(loginError) {
                    loginError.textContent = `Admin Login failed: ${error.message}`;
                    loginError.classList.remove('hidden');
                }
            } finally {
                if(loadingOverlay) loadingOverlay.classList.add('hidden');
            }
        }

        /**
         * Handles the Agent Email/Password Sign-In process (for Agents).
         */
        async function handleAgentLogin() {
            if(!agentLoginEmail || !agentLoginPassword || !agentSignInBtn || !loginError) return;
            
            const email = agentLoginEmail.value.trim();
            const password = agentLoginPassword.value.trim();

            if (!email || !password) {
                loginError.textContent = 'Please enter both email and password for Agent login.';
                loginError.classList.remove('hidden');
                return;
            }

            loginError.classList.add('hidden');
            agentSignInBtn.textContent = 'Signing In...';
            agentSignInBtn.disabled = true;

            try {
                if(loadingOverlay) loadingOverlay.classList.remove('hidden');
                // Use standard email/password sign in
                await signInWithEmailAndPassword(auth, email, password);
                // AuthStateChanged will handle role assignment and view change
            } catch (error) {
                console.error("Agent Sign-In failed:", error.code, error.message);
                loginError.textContent = `Agent Login failed: ${error.message}. (Check credentials and Firebase Auth setup)`;
                loginError.classList.remove('hidden');
            } finally {
                agentSignInBtn.textContent = 'Agent Sign In';
                agentSignInBtn.disabled = false;
                if(loadingOverlay) loadingOverlay.classList.add('hidden');
            }
        }
        
        /**
         * Handles the logout process.
         */
        async function handleLogout() {
            try {
                await signOut(auth);
                // Auth state change will handle view transition
            } catch (error) {
                console.error("Logout failed:", error);
            }
        }


        // --- LOTTERY MANAGEMENT (SHARED) ---

        /**
         * Sets up a listener for active lotteries to populate selectors.
         */
        function setupLotterySelectorListener() {
            const q = collection(db, COLLECTIONS.LOTTERIES);
            lotteryUnsub = onSnapshot(q, (snapshot) => {
                const lotteries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Populate Agent Lottery Select
                if(agentLotterySelect) {
                    agentLotterySelect.innerHTML = '<option value="">Select Lottery</option>';
                    lotteries.filter(l => l.status === 'Active').forEach(lottery => {
                        const option = document.createElement('option');
                        option.value = lottery.id;
                        option.textContent = `${lottery.title} (Fee: ₹${lottery.entryFee})`;
                        agentLotterySelect.appendChild(option);
                    });
                }
                
                // Populate Admin Lottery Filter
                if(adminLotteryFilter) {
                    adminLotteryFilter.innerHTML = '<option value="">All Lotteries</option>';
                    lotteries.forEach(lottery => {
                        const option = document.createElement('option');
                        option.value = lottery.id;
                        option.textContent = `${lottery.title} (${lottery.status})`;
                        adminLotteryFilter.appendChild(option);
                    });
                }
                
                // Enable agent generation button if lotteries exist
                if(agentGenerateBtn) {
                    agentGenerateBtn.disabled = lotteries.filter(l => l.status === 'Active').length === 0;
                }

                // Update countdown timer based on the next ending active lottery
                const nextEndDate = lotteries
                    .filter(l => l.status === 'Active' && l.endDate && l.endDate.toDate)
                    .map(l => l.endDate.toDate().getTime())
                    .sort((a, b) => a - b)[0];

                const countdownTimer = document.getElementById('countdown-timer');
                if (nextEndDate) {
                    startCountdown(nextEndDate);
                } else if(countdownTimer) {
                    countdownTimer.textContent = 'No active lotteries running.';
                }
            }, (error) => {
                console.error("Error listening to lotteries:", error);
                if(globalStatusMsg) {
                    globalStatusMsg.textContent = `Error loading lotteries: ${error.message}`;
                    globalStatusMsg.classList.remove('hidden');
                }
            });
        }
        
        /**
         * Starts a basic countdown timer.
         */
        function startCountdown(endTime) {
            clearInterval(window.lotteryCountdownInterval);
            const timerEl = document.getElementById('countdown-timer');
            if(!timerEl) return;

            window.lotteryCountdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = endTime - now;

                if (distance < 0) {
                    clearInterval(window.lotteryCountdownInterval);
                    timerEl.textContent = "Ticket sales have ended!";
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                timerEl.textContent = `Ticket sales ending in: ${days}d ${hours}h ${minutes}m ${seconds}s`;
            }, 1000);
        }

        // --- ADMIN FUNCTIONS ---

        function loadAdminData() {
            if(!adminAgentFilter || !adminLotteryFilter) return;

            // Load Agent Filter List (assuming agents exist in a collection or are hardcoded)
            adminAgentFilter.innerHTML = '<option value="">All Agents</option>';
            AGENT_EMAILS.forEach(email => {
                const agentId = 'AGENT-' + nanoid(4).toUpperCase(); // Placeholder ID logic
                const option = document.createElement('option');
                option.value = agentId;
                option.textContent = email;
                adminAgentFilter.appendChild(option);
            });
            
            // Set up listener for ALL participants
            setupAdminParticipantListener();
            adminLotteryFilter.addEventListener('change', setupAdminParticipantListener);
            adminAgentFilter.addEventListener('change', setupAdminParticipantListener);
        }

        function setupAdminParticipantListener() {
            if (adminUnsub) adminUnsub(); // Unsubscribe from previous listener
            
            const lotteryIdFilter = adminLotteryFilter.value;
            const agentIdFilter = adminAgentFilter.value;

            let q = collection(db, COLLECTIONS.PARTICIPANTS);
            const queryConstraints = [];

            if (lotteryIdFilter) {
                queryConstraints.push(where('lotteryId', '==', lotteryIdFilter));
            }
            if (agentIdFilter) {
                queryConstraints.push(where('agentId', '==', agentIdFilter));
            }
            
            q = queryConstraints.length > 0 ? query(q, ...queryConstraints) : q;
            
            adminUnsub = onSnapshot(q, (snapshot) => {
                renderAdminParticipants(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            }, (error) => {
                console.error("Error listening to admin participants:", error);
                if(globalStatusMsg) {
                    globalStatusMsg.textContent = `Error loading admin data: ${error.message}`;
                    globalStatusMsg.classList.remove('hidden');
                }
            });
        }

        function renderAdminParticipants(participants) {
            if(!adminParticipantsTable) return;
            adminParticipantsTable.innerHTML = '';
            if (participants.length === 0) {
                adminParticipantsTable.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No participants match the current filters.</td></tr>';
                return;
            }

            participants.forEach(p => {
                const statusClass = p.paymentStatus === 'Verified' ? 'verified' : (p.paymentStatus === 'Canceled' ? 'canceled' : 'pending');
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.serial}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${p.name}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${p.agentId}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${p.paymentProof || 'None'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-semibold ${statusClass}">${p.paymentStatus}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-right text-sm font-medium">
                        ${p.paymentStatus !== 'Verified' ? 
                            `<button data-id="${p.id}" class="admin-verify-btn text-green-600 hover:text-green-900 font-bold disabled:opacity-50" ${!p.paymentProof ? 'disabled' : ''}>Verify</button>` 
                            : `<span class="text-gray-400">Done</span>`}
                    </td>
                `;
                adminParticipantsTable.appendChild(row);
            });

            // Attach event listeners for verification buttons
            document.querySelectorAll('.admin-verify-btn').forEach(button => {
                button.addEventListener('click', handleVerifyPayment);
            });
        }

        async function handleVerifyPayment(event) {
            const docId = event.target.getAttribute('data-id');
            if (!docId) return;

            event.target.disabled = true;
            event.target.textContent = 'Verifying...';

            try {
                const docRef = doc(db, COLLECTIONS.PARTICIPANTS, docId);
                await updateDoc(docRef, {
                    paymentStatus: 'Verified',
                    verificationDate: serverTimestamp(),
                    verifiedBy: currentUserId
                });
                
                // The onSnapshot listener will update the table automatically
            } catch (error) {
                console.error("Error verifying payment:", error);
                if(globalStatusMsg) {
                    globalStatusMsg.textContent = `Verification failed: ${error.message}`;
                    globalStatusMsg.classList.remove('hidden');
                }
                event.target.disabled = false;
                event.target.textContent = 'Verify';
            }
        }
        
        async function handleAddLottery() {
            if (userRole !== 'admin') return;

            const lotteryTitle = document.getElementById('lottery-title');
            const lotteryFee = document.getElementById('lottery-fee');
            const lotteryMaxTickets = document.getElementById('lottery-max-tickets');
            const lotteryEndDate = document.getElementById('lottery-end-date');
            const lotteryDrawDate = document.getElementById('lottery-draw-date');
            const lotteryStatus = document.getElementById('lottery-status');
            const lotteryDescription = document.getElementById('lottery-description');
            const adminLotteryStatus = document.getElementById('admin-lottery-status');

            const title = lotteryTitle.value.trim();
            const fee = parseInt(lotteryFee.value, 10);
            const maxTickets = parseInt(lotteryMaxTickets.value, 10);
            const endDateStr = lotteryEndDate.value;
            const drawDateStr = lotteryDrawDate.value;
            const status = lotteryStatus.value;
            const description = lotteryDescription.value.trim();
            
            if (!title || !fee || !maxTickets || !endDateStr || !drawDateStr) {
                adminLotteryStatus.textContent = 'Please fill all required fields.';
                adminLotteryStatus.classList.remove('hidden');
                return;
            }

            const lotteryId = title.toUpperCase().replace(/\s/g, '').substring(0, 10) + '-' + nanoid(4).toUpperCase();
            
            adminLotteryStatus.textContent = 'Adding lottery...';
            adminLotteryStatus.classList.remove('hidden');

            try {
                // 1. Create the new Lottery Document
                const lotteryRef = doc(db, COLLECTIONS.LOTTERIES, lotteryId);
                await setDoc(lotteryRef, {
                    lotteryId: lotteryId,
                    title: title,
                    entryFee: fee,
                    startDate: serverTimestamp(), // Assumes sales start immediately upon creation
                    endDate: new Date(endDateStr), 
                    drawDate: new Date(drawDateStr),
                    maxTickets: maxTickets,
                    description: description,
                    status: status,
                    createdBy: currentUserId
                });
                
                // 2. Initialize the separate Serial Counter for this lottery
                const counterRef = doc(db, COLLECTIONS.COUNTERS, lotteryId);
                await setDoc(counterRef, { currentSerial: 0, lotteryId: lotteryId });


                adminLotteryStatus.textContent = `Lottery "${title}" added successfully! ID: ${lotteryId}`;
                adminLotteryStatus.classList.add('text-green-500');
                
                // Clear inputs
                lotteryTitle.value = '';
                lotteryEndDate.value = '';
                lotteryDrawDate.value = '';
                lotteryDescription.value = '';

            } catch (error) {
                console.error("Error adding lottery:", error);
                adminLotteryStatus.textContent = `Error: ${error.message}`;
                adminLotteryStatus.classList.add('text-red-500');
            }
        }


        // --- AGENT FUNCTIONS ---
        
        function loadAgentData() {
            if (agentUnsub) agentUnsub(); // Clear previous participant list listener
            if (agentStatsUnsub) agentStatsUnsub(); // Clear previous stats listener

            // 1. Setup Participant List Listener (Filters by current agent's ID)
            const qParticipants = query(
                collection(db, COLLECTIONS.PARTICIPANTS),
                where('agentId', '==', currentAgentId)
            );
            
            agentUnsub = onSnapshot(qParticipants, (snapshot) => {
                const participants = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAgentParticipants(participants);
                updateAgentStats(participants);
            }, (error) => {
                console.error("Error listening to agent participants:", error);
                if(agentStatus) {
                    agentStatus.textContent = `Error loading participants: ${error.message}`;
                    agentStatus.classList.remove('hidden');
                }
            });
        }
        
        function updateAgentStats(participants) {
            const total = participants.length;
            const pending = participants.filter(p => p.paymentStatus === 'Pending').length;
            const verified = participants.filter(p => p.paymentStatus === 'Verified').length;

            document.getElementById('agent-stat-total').textContent = total;
            document.getElementById('agent-stat-pending').textContent = pending;
            document.getElementById('agent-stat-verified').textContent = verified;
        }

        function renderAgentParticipants(participants) {
            if(!agentParticipantsTable) return;
            agentParticipantsTable.innerHTML = '';
            if (participants.length === 0) {
                agentParticipantsTable.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No participants registered yet.</td></tr>';
                return;
            }

            participants.forEach(p => {
                const statusClass = p.paymentStatus === 'Verified' ? 'verified' : (p.paymentStatus === 'Canceled' ? 'canceled' : 'pending');
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.serial}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${p.name} <br>
                        <span class="text-xs text-gray-400">${p.phone || 'No Phone'}</span>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${p.lotteryId}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${p.paymentProof || 'N/A'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-semibold ${statusClass}">${p.paymentStatus}</td>
                `;
                agentParticipantsTable.appendChild(row);
            });
        }


        async function handleGenerateSerial() {
            if (userRole !== 'agent') return;
            
            const lotteryId = agentLotterySelect.value;
            const name = agentParticipantName.value.trim();
            const phone = agentParticipantPhone.value.trim();
            const proofRef = agentPaymentProofRef.value.trim();

            if (!lotteryId || !name) {
                if(agentStatus) {
                    agentStatus.textContent = 'Please select a Lottery and enter Participant Name.';
                    agentStatus.classList.remove('hidden');
                }
                return;
            }
            
            if(agentGenerateBtn) agentGenerateBtn.disabled = true;
            if(agentStatus) {
                agentStatus.textContent = 'Generating unique serial number...';
                agentStatus.classList.remove('hidden');
                agentStatus.classList.remove('text-red-500');
            }

            const counterRef = doc(db, COLLECTIONS.COUNTERS, lotteryId);
            const participantCollectionRef = collection(db, COLLECTIONS.PARTICIPANTS);
            let newSerial = '';

            try {
                // 1. TRANSACTION: Atomically increment the serial counter for the selected lottery
                await runTransaction(db, async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);

                    if (!counterDoc.exists()) {
                        throw "Lottery Counter not initialized. Contact Admin.";
                    }

                    const currentSerialNum = counterDoc.data().currentSerial || 0;
                    const nextSerialNum = currentSerialNum + 1;
                    
                    // Format Serial: LOTTERY_ID_PREFIX-001
                    const lotteryPrefix = lotteryId.substring(0, 5).toUpperCase();
                    newSerial = `${lotteryPrefix}-${String(nextSerialNum).padStart(3, '0')}`;

                    transaction.update(counterRef, {
                        currentSerial: nextSerialNum,
                        lastUpdated: serverTimestamp()
                    });
                });

                // 2. LEDGER ENTRY: Record the new participant
                await addDoc(participantCollectionRef, {
                    serial: newSerial,
                    lotteryId: lotteryId,
                    name: name,
                    phone: phone,
                    agentId: currentAgentId,
                    registrationDate: serverTimestamp(),
                    paymentStatus: 'Pending', // Agent collects payment offline, so status defaults to Pending
                    paymentProof: proofRef, 
                    email: null, // Participant email/address simplified/omitted for agent workflow
                    address: null 
                });

                if(agentStatus) {
                    agentStatus.textContent = `Success! Serial Number: ${newSerial} generated for ${name}. Status: Pending Verification.`;
                    agentStatus.classList.add('text-green-500');
                }
                
                // Clear inputs after successful registration
                agentParticipantName.value = '';
                agentParticipantPhone.value = '';
                agentPaymentProofRef.value = '';

            } catch (e) {
                console.error("Serial generation transaction failed: ", e);
                if(agentStatus) {
                    agentStatus.textContent = `Error generating serial. ${e.message || e}`;
                    agentStatus.classList.add('text-red-500');
                }
            } finally {
                if(agentGenerateBtn) agentGenerateBtn.disabled = false;
                setTimeout(() => { if(agentStatus) agentStatus.classList.add('hidden'); }, 5000);
            }
        }
        
        // --- PARTICIPANT VERIFICATION FUNCTIONS ---

        async function handleVerification() {
            if(!verificationSerial || !verificationSubmitBtn) return;
            
            const serial = verificationSerial.value.trim().toUpperCase();
            if(verificationResult) verificationResult.classList.add('hidden');
            if(verificationStatusMessage) verificationStatusMessage.classList.add('hidden');
            
            if (!serial) {
                if(verificationStatusMessage) {
                    verificationStatusMessage.textContent = 'Please enter a serial number.';
                    verificationStatusMessage.classList.remove('hidden');
                }
                return;
            }

            verificationSubmitBtn.disabled = true;
            if(verificationStatusMessage) {
                verificationStatusMessage.textContent = 'Checking status...';
                verificationStatusMessage.classList.remove('hidden');
            }
            
            try {
                // Query the Participants collection for the serial number
                const q = query(
                    collection(db, COLLECTIONS.PARTICIPANTS),
                    where('serial', '==', serial)
                );
                
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    if(verificationStatusMessage) {
                        verificationStatusMessage.textContent = `Error: Serial number ${serial} not found.`;
                        verificationStatusMessage.classList.add('text-red-500');
                    }
                } else {
                    const participant = snapshot.docs[0].data();
                    
                    // Fetch the lottery title for display
                    const lotteryDoc = await getDoc(doc(db, COLLECTIONS.LOTTERIES, participant.lotteryId));
                    const lotteryTitle = lotteryDoc.exists() ? lotteryDoc.data().title : participant.lotteryId;
                    
                    const statusClass = participant.paymentStatus === 'Verified' ? 'verified' : 'pending';
                    const statusText = participant.paymentStatus === 'Verified' ? 'Verified' : 'Pending Payment Confirmation';
                    
                    if(verificationStatusOutput) {
                        verificationStatusOutput.textContent = statusText;
                        verificationStatusOutput.className = `text-2xl font-bold mt-2 ${statusClass}`;
                    }
                    if(verificationLotteryOutput) verificationLotteryOutput.textContent = `Lottery: ${lotteryTitle}`;
                    if(verificationNameOutput) verificationNameOutput.textContent = `Name: ${participant.name}`;
                    
                    if(verificationResult) verificationResult.classList.remove('hidden');
                    if(verificationStatusMessage) verificationStatusMessage.classList.add('hidden');
                }

            } catch (e) {
                console.error("Verification failed: ", e);
                if(verificationStatusMessage) {
                    verificationStatusMessage.textContent = `An error occurred during verification. ${e.message || e}`;
                    verificationStatusMessage.classList.add('text-red-500');
                }
            } finally {
                verificationSubmitBtn.disabled = false;
            }
        }


        // --- EVENT LISTENERS AND INITIAL CALL ---

        window.onload = () => {
            // 1. Fetch all elements and attach listeners
            setupListenersAndElements();

            // 2. Start Firebase initialization
            if(globalStatusMsg) {
                globalStatusMsg.textContent = 'Please wait while Firebase authenticates. If you are an Agent or Admin, use the Sign In button.';
                globalStatusMsg.classList.remove('hidden');
            }
            initFirebase();
        };

    </script>

</body>
</html>
